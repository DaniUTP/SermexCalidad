pipeline {
    agent any

    environment {
        PROJECT_DIR   = "${WORKSPACE}\\project"
        SOURCE_REPO   = "https://github.com/ZoneMinder/zoneminder.git"
        TARGET_REPO   = "https://github.com/DaniUTP/SermexCalidad.git"
        SONAR_SCANNER = "C:\\Users\\Daniel\\Documents\\Actividades avanzadas calidad de software\\expo calidad repo daniel\\sonar-scanner-cli-7.3.0.5189-windows-x64\\sonar-scanner-7.3.0.5189-windows-x64\\bin\\sonar-scanner.bat"
    }

    stages {
        stage('Preparar Workspace') {
            steps {
                bat """
                if exist "${PROJECT_DIR}" rd /s /q "${PROJECT_DIR}"
                mkdir "${PROJECT_DIR}"
                """
            }
        }

        stage('Clonar Repositorio Zoneminder') {
            steps {
                bat """
                cd /d "${PROJECT_DIR}"
                git clone ${SOURCE_REPO} src
                """
            }
        }

        stage('Analizar con SonarQube') {
            steps {
                withCredentials([string(credentialsId: 'sonarqube', variable: 'TOKEN')]) {
                    bat """
                    cd /d "${PROJECT_DIR}\\src"
                    "${SONAR_SCANNER}" ^
                        -Dsonar.projectKey=SERMEX ^
                        -Dsonar.sources=. ^
                        -Dsonar.host.url=http://localhost:9000 ^
                        -Dsonar.token=%TOKEN%
                    """
                }
            }
        }

        stage('Obtener y Validar Métricas SonarQube') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'sonarqube', variable: 'TOKEN')]) {

                        def metricsUrl = "http://localhost:9000/api/measures/component?component=SERMEX&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots"

                        bat """
                        curl -s -u %TOKEN%: "${metricsUrl}" -o "${PROJECT_DIR}\\metrics.json"
                        """

                        def parseJson = { text -> new groovy.json.JsonSlurper().parseText(text) }
                        def json = parseJson(readFile("${PROJECT_DIR}\\metrics.json"))

                        echo "Metricas obtenidas del analisis del proyecto:"

                        def metrics = [:]
                        json.component.measures.each { m ->
                            metrics[m.metric] = (m.value ?: "0").toFloat()
                            echo "${m.metric}: ${m.value}"
                        }

                        def errores = []

                        if (metrics['bugs'] > 0)
                            errores << "Bugs detectados: ${metrics['bugs']}"

                        if (metrics['vulnerabilities'] > 0)
                            errores << "Vulnerabilidades encontradas: ${metrics['vulnerabilities']}"

                        if (metrics['code_smells'] > 20)
                            errores << "Demasiados code smells: ${metrics['code_smells']}"

                        if (metrics['coverage'] < 80)
                            errores << "Cobertura baja: ${metrics['coverage']}%"

                        if (metrics['duplicated_lines_density'] > 5)
                            errores << "Código duplicado mayor a 5%: ${metrics['duplicated_lines_density']}%"

                        if (metrics['security_hotspots'] > 0)
                            errores << "Security Hotspots encontrados: ${metrics['security_hotspots']}"

                        if (errores) {
                            echo "HAY ERRORES EN EL CÓDIGO"
                            errores.each { e -> echo e }
                            error "El código no cumple los requisitos mínimos. Se cancela el push."
                        }

                        echo "EL CODIGO CUMPLE LOS REQUISITOS MINIMOS"
                        echo "El código cumple todos los criterios. Continúa el pipeline."
                    }
                }
            }
        }
        stage('Clonar Repositorio SermexCalidad') {
            steps {
                bat """
                cd /d "${PROJECT_DIR}"
                git clone ${TARGET_REPO} target
                """
            }
        }

        stage('Copiar Código Aprobado') {
            steps {
                bat """
                xcopy "${PROJECT_DIR}\\src\\*" "${PROJECT_DIR}\\target\\" /E /H /C /Y
                """
            }
        }

        stage('Commit y Push') {
            steps {
                withCredentials([string(credentialsId: 'github_token', variable: 'GIT_TOKEN')]) {
                    bat """
                    cd /d "${PROJECT_DIR}\\target"

                    git config --global user.email "aldanagerardo24@gmail.com"
                    git config --global user.name "Daniel Aldana"

                    git remote set-url origin https://DaniUTP:%GIT_TOKEN%@github.com/DaniUTP/SermexCalidad.git

                    rem Excluir .scannerwork de Git
                    echo ".scannerwork" > .gitignore

                    git add .
                    git commit -m "Push automático desde Jenkins (Quality Gate OK)" || echo "Sin cambios para commit"

                    git push origin main --force
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completado correctamente. Código aprobado y push realizado."
        }
        failure {
            echo "Pipeline falló. Quality Gate no aprobado o error en ejecución."
        }
    }
}
